# Task: Rename PageBuilder to Pages

**Started:** 2025-11-28
**Last Updated:** 2025-11-28 13:30
**Status:** In Progress

## Overview
Renaming all "page-builder", "PageBuilder", "pageBuilder" references to "pages" for consistency and simplicity. This includes routes, controllers, Vue components, database tables, and all related references.

## Progress Tracker
- [x] Rename routes file from pagebuilder.php to pages.php
- [x] Update route paths from /admin/page-builder to /admin/pages
- [x] Update route names from admin.page-builder.* to admin.pages.*
- [x] Rename Vue directory from Admin/PageBuilder to Admin/Pages
- [x] Update Inertia render paths in controller
- [x] Update route references in Vue components
- [x] Update model table names
- [x] Update navigation and breadcrumbs
- [x] Update CLAUDE.md with task tracking rules
- [x] Update CLAUDE.md route structure
- [ ] Rebuild frontend assets (IN PROGRESS)
- [ ] Fix frontend rendering issue - pages showing JSON instead of formatted content
- [ ] Test page creation workflow
- [ ] Test page editing workflow
- [ ] Test page deletion workflow

## Current Status
**Completed:**
- Routes file renamed to `routes/admin/pages.php`
- Route prefix changed to `/admin/pages`
- Route names changed to `admin.pages.*`
- Vue directory renamed to `resources/js/pages/Admin/Pages/`
- All Inertia render paths updated in PageController
- All route references updated in Vue components (Index.vue, Create.vue, Edit.vue)
- AppSidebar updated to use `pages` instead of `pageBuilder`
- Page model table name updated to `pages`
- PageRevision model table name updated to `page_revisions`
- CLAUDE.md updated with task tracking section
- CLAUDE.md route structure updated
- Wayfinder routes regenerated

**In Progress:**
- Testing page creation and editing workflows
- Verifying page publishing functionality

**Blocked:**
- None

## Files Modified
**Backend:**
- `routes/admin/pagebuilder.php` â†’ RENAMED to `routes/admin/pages.php`
- `routes/admin/pages.php` - Updated prefix to 'pages', route names to 'pages.*'
- `routes/admin.php` - Updated require path
- `routes/web.php` - Updated comment
- `app/Domains/PageBuilder/Http/Controllers/Admin/PageController.php` - Updated Inertia render paths and route names
- `app/Domains/PageBuilder/Models/Page.php` - Updated table name to 'pages'
- `app/Domains/PageBuilder/Models/PageRevision.php` - Updated table name to 'page_revisions'
- `database/migrations/2025_11_28_182830_rename_pagebuilder_tables_to_pages.php` - Created migration
- `database/migrations/2025_11_28_000000_drop_legacy_pagebuilder_tables.php` - DELETED (no longer needed)

**Frontend:**
- `resources/js/pages/Admin/PageBuilder/` â†’ RENAMED to `resources/js/pages/Admin/Pages/`
- `resources/js/pages/Admin/Pages/Index.vue` - Updated all route references
- `resources/js/pages/Admin/Pages/Create.vue` - Updated all route references
- `resources/js/pages/Admin/Pages/Edit.vue` - Updated all route references
- `resources/js/components/AppSidebar.vue` - Updated import and usage from pageBuilder to pages
- `resources/js/routes/admin/pages/index.ts` - Auto-generated by wayfinder

**Documentation:**
- `CLAUDE.md` - Added comprehensive task tracking section
- `CLAUDE.md` - Updated route structure to reflect /admin/pages
- `TASK_RENAME_PAGEBUILDER_TO_PAGES.md` - This file

## Next Steps
1. Clear all caches and rebuild frontend assets successfully
2. Investigate why pages show JSON instead of rendered content
3. Fix the frontend rendering to properly display markdown/shortcode content
4. Test full page creation workflow
5. Test full page editing workflow
6. Test page deletion
7. Run test suite to ensure no regressions
8. Update any remaining documentation

## Testing Notes
- [ ] Create new page via /admin/pages/create
- [ ] Verify page appears in /admin/pages list
- [ ] Edit existing page
- [ ] Delete page
- [ ] Verify public page rendering works (/{slug})
- [ ] Run full test suite: `./vendor/bin/sail pest`

## Frontend Rendering Issue
**Problem:** Pages are displaying raw JSON data instead of formatted content.

**Example JSON shown:**
```json
{
  "title": "Contenta - the CMS built for Teams...",
  "subtitle": "No plugin bloat...",
  "textAlign": "center",
  "description": "Ship content-driven websites...",
  ...
}
```

**Hypothesis:** The frontend is receiving the page data but not processing it through the shortcode parser/markdown renderer. Need to investigate:
1. How pages are rendered on frontend (PageController@show)
2. If MarkdownRenderService is being called
3. If shortcode parsing is working
4. Layout template rendering

## Rollback Instructions
If this needs to be reverted:
1. Run migration rollback: `./vendor/bin/sail artisan migrate:rollback`
2. Rename routes/admin/pages.php back to routes/admin/pagebuilder.php
3. Rename Vue directory back: `mv resources/js/pages/Admin/Pages resources/js/pages/Admin/PageBuilder`
4. Revert all file changes using git: `git checkout app/ routes/ resources/`
5. Regenerate wayfinder: `./vendor/bin/sail artisan wayfinder:generate`
6. Rebuild assets: `npm run build`

## Updates - 2025-11-28 13:36

### Additional Fixes
- Fixed validation rules in PageController:
  - `store()` method: Changed `unique:pagebuilder_pages,slug` to `unique:pages,slug`
  - `update()` method: Changed `Rule::unique('pagebuilder_pages', 'slug')` to `Rule::unique('pages', 'slug')`
- Fixed ParseException class property conflict:
  - Renamed `$line` to `$sourceLine` and `$column` to `$sourceColumn`
  - This resolves conflict with parent Exception class properties that cannot be redeclared as readonly

### Issues Resolved
- **SQLSTATE[42S02]: Table 'pagebuilder_pages' doesn't exist** - Fixed by updating validation rules
- **ParseException property conflict** - Renamed `$line` and `$column` to `$sourceLine` and `$sourceColumn` to avoid conflict with parent Exception class properties

### Remaining Items
- [x] Routes verified - all admin.pages.* routes properly configured
- [x] Caches cleared - routes, config, and application cache
- [x] All code references verified - PageController, Edit.vue, Index.vue, Create.vue all using correct paths
- [ ] Manual testing of page editing at `/admin/pages/{id}/edit`
- [ ] Manual testing of page creation at `/admin/pages/create`
- [ ] Test publish functionality to generate HTML
- [ ] Test frontend rendering after publishing

## Updates - 2025-11-28 14:00

### Work Completed
1. **Fixed Critical ParseException Bug**
   - Identified property redeclaration conflict with parent Exception class
   - Renamed `$line` â†’ `$sourceLine` and `$column` â†’ `$sourceColumn`
   - This fixes the 500 error on `/admin/pages/{id}/preview` endpoint

2. **System Verification**
   - Cleared all Laravel caches (routes, config, application)
   - Verified all 10 admin.pages.* routes are properly configured
   - Confirmed all Vue components use correct route paths:
     - Edit.vue: `/admin/pages/${id}` for updates
     - Edit.vue: `/admin/pages/${id}/publish` for publishing
     - Edit.vue: `/admin/pages/${id}/preview` for previews
     - Index.vue: `/admin/pages` for listing
     - Create.vue: `/admin/pages` for creating

3. **Database Status**
   - Tables successfully renamed: `pages` and `page_revisions`
   - 7 pages exist in the database ready for testing
   - All validation rules updated to use correct table names

### Files Modified in This Session
- `app/Domains/ContentManagement/Services/ShortcodeParser/Exceptions/ParseException.php`
  - Renamed readonly properties to avoid parent class conflict

### Current Status
The renaming from PageBuilder to Pages is **functionally complete**. All code references, routes, database tables, and validation rules have been updated. The application is ready for manual testing through the browser interface.

## Updates - 2025-11-28 19:12

### Real-time Shortcode Validation System Implemented

Implemented a comprehensive real-time validation system for shortcode syntax that prevents saving pages with errors.

#### Features
1. **Real-time Validation**
   - Validates markdown content as user types (800ms debounce)
   - Shows validation status in sidebar
   - Errors disappear automatically as they're fixed
   - Visual indicators: âš ï¸ render errors, âŒ parse errors, ðŸ”´ fatal errors

2. **Validation Enforcement**
   - Save button disabled when validation errors exist
   - Publish button disabled when validation errors exist
   - Alert shown if user tries to save with errors
   - Clear error messages with line/column information

3. **User Interface**
   - Collapsible validation sidebar (320px width)
   - Toggle button shows error count or "Valid" status
   - Red ring on toggle button when errors exist
   - Color-coded error cards (yellow/red/dark red)
   - Helpful tips section in sidebar
   - Sticky sidebar scrolls with page

#### Files Created
- `resources/js/composables/useShortcodeValidation.ts`
  - Composable for validation logic
  - Debounced validation (800ms)
  - Real-time error tracking
  - Auto-validates on content changes

#### Files Modified
- `routes/admin/pages.php`
  - Added `/admin/pages/validate` route (POST)

- `app/Domains/PageBuilder/Http/Controllers/Admin/PageController.php`
  - Added `validate()` method
  - Catches RenderException, ParseException, and generic exceptions
  - Returns JSON with validation status and error details

- `resources/js/pages/Admin/Pages/Edit.vue`
  - Integrated useShortcodeValidation composable
  - Added validation sidebar with error list
  - Added validation toggle button
  - Save/publish buttons disabled when !isValid
  - Alert shown when attempting to save with errors

- `resources/js/pages/Admin/Pages/Create.vue`
  - Same validation integration as Edit.vue
  - Consistent UX across create and edit workflows

#### Validation Response Format
```json
{
    "valid": boolean,
    "errors": [
        {
            "type": "render|parse|unknown|fatal",
            "message": "Error description",
            "line": number|null,
            "column": number|null
        }
    ]
}
```

#### Error Types
- **Render**: Missing required attributes (e.g., `buttonText` for `[#cta]`)
- **Parse**: Syntax errors in shortcode structure
- **Fatal**: Critical errors preventing validation
- **Unknown**: Unexpected errors during validation

### Testing Ready
The validation system is now active and ready for testing:
1. Visit `/admin/pages/create` or `/admin/pages/{id}/edit`
2. Try adding a `[#cta]` shortcode without required attributes
3. Watch the validation sidebar show errors in real-time
4. Add the required attributes and see errors disappear
5. Try to save with errors - button should be disabled

## Updates - 2025-11-28 19:20

### Fixed Frontend Rendering Issue

Fixed the issue where pages showed raw JSON instead of rendered HTML on the frontend.

#### Problem
- Pages were displaying raw JSON data from the legacy `data` field
- `content_html` was null because pages hadn't been published
- Page.vue TypeScript interface had incorrect structure
- Page.vue was checking wrong location for content_html

#### Root Cause
1. **Pages not published**: The `published_html` field is only populated when you click "Publish" button
2. **Interface mismatch**: Page.vue expected `content_html` inside `data` object, but PageController passes it at root level
3. **Poor error messaging**: Fallback showed confusing JSON dump instead of helpful message

#### Files Modified
- `resources/js/pages/Page.vue`
  - Fixed TypeScript interface to match actual data structure
  - Updated `getContentHtml()` to check root level `content_html`
  - Added proper "Page Not Published" message when `content_html` is null
  - Added "Page Not Found" message for missing pages
  - Improved overall UX with better error states

#### Changes Made
```typescript
// OLD interface (incorrect)
interface PageData {
    data: {
        content_html?: string;  // Wrong location!
    };
}

// NEW interface (correct)
interface PageData {
    content_html?: string | null;  // At root level
    content_markdown?: string | null;
    data: {
        sections?: BlockConfig[];  // Only legacy data
    };
}
```

#### How It Works Now
1. **Published pages**: Display rendered HTML from `content_html`
2. **Legacy pages**: Render sections from `data.sections` (backward compatible)
3. **Unpublished pages**: Show friendly "Page Not Published" message
4. **Missing pages**: Show "Page Not Found" with link to home

#### Action Required
**To fix existing pages showing JSON:**
1. Go to `/admin/pages`
2. Click "Edit" on any page
3. Click the "Publish" button (green button in top right)
4. This will generate the HTML and store it in `published_html`
5. Now visit the public page at `/{slug}` - it will render correctly!

**Publishing Process:**
- Edit page â†’ Click "Publish" â†’ `PublishPageAction` runs
- Validates markdown content
- Renders markdown through shortcode parser
- Stores HTML in `published_html` column
- Sets status to 'published'
- Public route now shows the rendered HTML

## Updates - 2025-11-28 19:47

### Fixed Page Revision NULL Constraint Error

Fixed the error: "SQLSTATE[23000]: Integrity constraint violation: 1048 Column 'data' cannot be null"

#### Problem
When saving pages (especially markdown-only pages), the `createRevision()` method was trying to insert `null` into the `page_revisions.data` column, which has a NOT NULL constraint.

#### Root Cause
- Markdown pages don't use the legacy `data` field (they use `markdown_content`)
- The `data` field was being set to `null` for markdown pages
- `PageController::createRevision()` was passing `$page->data` directly without handling null

#### Files Modified

**app/Domains/PageBuilder/Http/Controllers/Admin/PageController.php**
- Line 334: `'data' => $page->data ?? []` - Use empty array if data is null
- Line 342: `'schema_data' => $page->schema_data ?? []` - Use empty array if schema_data is null
- Lines 103-104: Added defaults when creating new pages to ensure data is never null
  ```php
  $validated['data'] = $validated['data'] ?? [];
  $validated['schema_data'] = $validated['schema_data'] ?? [];
  ```

**app/Domains/PageBuilder/Models/Page.php**
- Line 51: Changed default content_type from 'legacy' to 'markdown'
- Line 52: Changed default data from legacy structure to empty array `'[]'`

#### What Changed
1. âœ… `createRevision()` now uses `??` operator to provide empty arrays for null values
2. âœ… `store()` method ensures data/schema_data are never null when creating pages
3. âœ… Page model defaults updated for markdown-first approach
4. âœ… Fixed existing page (ID 5) to have empty array instead of null

#### Result
Pages can now be saved and updated without database constraint violations. All revisions are created successfully with empty arrays for unused fields.

