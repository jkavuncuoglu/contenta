# API Tokens Management

This document describes the Personal API Tokens management system implemented in the Security domain.

## Overview

The API Tokens management feature allows users to create, manage, and revoke personal access tokens for API authentication using Laravel Sanctum. Tokens can be scoped with specific abilities to control access levels.

## Architecture

All API token functionality is organized under the Security domain:

```
app/Domains/Security/ApiTokens/
├── Constants/
│   └── TokenAbility.php          # Token ability constants
├── Http/
│   ├── Controllers/
│   │   └── ApiTokenController.php # Main controller
│   └── Requests/
│       ├── CreateApiTokenRequest.php
│       └── UpdateApiTokenRequest.php
└── Services/
    └── ApiTokenService.php        # Business logic
```

## Features

### Token Abilities

Tokens can be created with the following abilities:

- **Read**: Read access to resources
- **Write**: Create and update resources  
- **Delete**: Delete resources
- **Full Access**: All abilities (default)

### Security Features

- Maximum of 10 tokens per user
- Tokens are only displayed once upon creation
- Token last used tracking
- Secure token deletion
- Bulk token deletion with confirmation

## Backend Components

### Constants

**TokenAbility** (`app/Domains/Security/ApiTokens/Constants/TokenAbility.php`)
- Defines available token abilities
- Provides helper methods for ability management

### Service Layer

**ApiTokenService** (`app/Domains/Security/ApiTokens/Services/ApiTokenService.php`)

Methods:
- `getTokens(User $user)` - Get all tokens for a user
- `createToken(User $user, string $name, array $abilities)` - Create new token
- `deleteToken(User $user, string $tokenId)` - Delete specific token
- `deleteAllTokens(User $user)` - Delete all user tokens
- `updateTokenAbilities(User $user, string $tokenId, array $abilities)` - Update token abilities
- `updateTokenName(User $user, string $tokenId, string $name)` - Update token name
- `hasReachedMaxTokens(User $user, int $maxTokens)` - Check token limit

### HTTP Layer

**ApiTokenController** (`app/Domains/Security/ApiTokens/Http/Controllers/ApiTokenController.php`)

Endpoints:
- `GET /user/settings/api-tokens` - Display API tokens page
- `POST /user/settings/api-tokens` - Create new token
- `PUT /user/settings/api-tokens/{tokenId}` - Update token
- `DELETE /user/settings/api-tokens/{tokenId}` - Delete specific token
- `DELETE /user/settings/api-tokens` - Delete all tokens

### Form Requests

**CreateApiTokenRequest** - Validates token creation:
- `name` (required, string, max:255)
- `abilities` (optional, array of valid abilities)

**UpdateApiTokenRequest** - Validates token updates:
- `name` (optional, string, max:255)
- `abilities` (optional, array of valid abilities)

### Routes

Routes are defined in `routes/user/settings/api-tokens.php` and are automatically included in the settings route group.

## Frontend Components

### Main Component

**ApiTokens.vue** (`resources/js/pages/settings/ApiTokens.vue`)

Features:
- Token list with abilities display
- Create token dialog with ability selection
- Token display dialog (shown once after creation)
- Delete confirmation dialogs
- Token copy functionality
- Usage instructions

### UI Components Used

- Dialog (for create/display modals)
- AlertDialog (for delete confirmations)
- Checkbox (for ability selection)
- Badge (for ability display)
- Input, Label, Button (standard form elements)

### Route Integration

TypeScript route definitions are automatically generated by Laravel Wayfinder:
- `settings.apiTokens.index()`
- `settings.apiTokens.store()`
- `settings.apiTokens.update(tokenId)`
- `settings.apiTokens.destroy(tokenId)`
- `settings.apiTokens.destroyAll()`

## Usage

### Creating a Token

1. Navigate to Settings > API Tokens
2. Click "Create Token"
3. Enter a token name
4. (Optional) Select specific abilities
5. Click "Create Token"
6. **Important**: Copy the displayed token immediately - it won't be shown again

### Using a Token

Include the token in API requests:

```bash
curl -H "Authorization: Bearer YOUR_TOKEN_HERE" \
     https://your-domain.com/api/endpoint
```

### Managing Tokens

- View all tokens with their abilities and last used date
- Delete individual tokens
- Delete all tokens at once
- Tokens automatically track when they were last used

## Database

### Table: personal_access_tokens

Columns:
- `id` - Primary key
- `tokenable_type` - Polymorphic type (User)
- `tokenable_id` - User ID
- `name` - Token name
- `token` - Hashed token (64 chars, unique)
- `abilities` - JSON array of abilities
- `last_used_at` - Timestamp of last use
- `expires_at` - Optional expiration (indexed)
- `created_at` - Creation timestamp
- `updated_at` - Update timestamp

## Security Considerations

1. **Token Storage**: Tokens are hashed in the database using SHA-256
2. **One-Time Display**: Plain text tokens are only shown once upon creation
3. **Rate Limiting**: Consider adding rate limiting to API endpoints
4. **Token Limits**: Maximum 10 tokens per user (configurable)
5. **Abilities**: Use specific abilities instead of full access when possible
6. **Revocation**: Users can revoke tokens at any time

## Configuration

### Maximum Tokens

Adjust in controller or create config file:

```php
// In ApiTokenController
return Inertia::render('settings/ApiTokens', [
    'maxTokens' => config('sanctum.max_tokens_per_user', 10),
]);
```

### Token Abilities

Add or modify abilities in `TokenAbility.php`:

```php
public const CUSTOM = 'custom';

public static function all(): array
{
    return [
        self::READ => 'Read access to resources',
        self::WRITE => 'Create and update resources',
        self::DELETE => 'Delete resources',
        self::CUSTOM => 'Custom ability description',
    ];
}
```

## API Middleware

Protect API routes with Sanctum middleware:

```php
Route::middleware('auth:sanctum')->group(function () {
    Route::get('/api/user', function (Request $request) {
        return $request->user();
    });
    
    // Check for specific ability
    Route::delete('/api/resource/{id}', function () {
        //
    })->middleware('ability:delete');
});
```

## Testing

Example test for token creation:

```php
public function test_user_can_create_api_token()
{
    $user = User::factory()->create();
    
    $response = $this->actingAs($user)
        ->post('/user/settings/api-tokens', [
            'name' => 'Test Token',
            'abilities' => ['read', 'write'],
        ]);
    
    $response->assertSessionHas('plainTextToken');
    $this->assertCount(1, $user->tokens);
}
```

## Future Enhancements

Potential improvements:
- Token expiration dates
- Token usage statistics
- IP whitelist for tokens
- Token scopes per resource
- API usage rate limiting
- Token activity logs
- Email notifications on token creation/deletion

## Related Files

- User Model: `app/Models/User.php` (HasApiTokens trait)
- Settings Layout: `resources/js/layouts/settings/Layout.vue`
- Route Definitions: `resources/js/routes/user/settings/api-tokens/index.ts`
- Migration: `database/migrations/*_create_personal_access_tokens_table.php`

